<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Basic Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- SEO Meta Tags (Dynamically Loaded) -->
    <title id="page-title">Free COC Gems — Clash of Clans Generator, Tips & Guides</title>
    <meta id="meta-description" name="description" content="Get Free COC Gems with safe methods. Learn how to use a free Clash of Clans gem generator, discover how to get free gems, and why unlimited gems hacks don’t work.">
    <meta id="meta-keywords" name="keywords" content="">
    
    <!-- Favicon Link -->
    <link rel="icon" type="image/png" href="https://example.com/favicon.png">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://example.com/" />

    <!-- Open Graph Tags (Dynamically Loaded) -->
    <meta id="og-title" property="og:title" content="Free COC Gems — Clash of Clans Generator, Tips & Guides">
    <meta id="og-description" property="og:description" content="Get Free COC Gems with safe methods. Learn how to use a free Clash of Clans gem generator, discover how to get free gems, and why unlimited gems hacks don’t work.">
    <meta property="og:image" content="https://example.com/og-image.jpg">
    <meta property="og:url" content="https://example.com/">
    <meta property="og:type" content="website">

    <!-- Twitter Card Tags (Dynamically Loaded) -->
    <meta name="twitter:card" content="summary_large_image">
    <meta id="twitter-title" name="twitter:title" content="Free COC Gems — Clash of Clans Generator, Tips & Guides">
    <meta id="twitter-description" name="twitter:description" content="Get Free COC Gems with safe methods. Learn how to use a free Clash of Clans gem generator, discover how to get free gems, and why unlimited gems hacks don’t work.">
    <meta name="twitter:image" content="https://example.com/og-image.jpg">

    <!-- JSON-LD Schema for Rich Snippets -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "Clash of Clans Gem Top-up",
      "url": "https://example.com/",
      "logo": "https://example.com/logo.png"
    }
    </script>
    
    <!-- External Fonts and Stylesheets -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Supercell-Magic:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    
    <!-- Internal CSS -->
    <style>
        :root {
            --coc-blue: #4c92a6;
            --coc-gold: #f7b600;
            --coc-red: #e54a4a;
            --background-dark: #1a1a1a;
            --card-dark: rgba(0, 0, 0, 0.7);
            --input-dark: rgba(0, 0, 0, 0.5);
            --border-color: rgba(247, 182, 0, 0.4);
            --text-color: #ffffff;
            --text-light: #cccccc;
            --card-shadow: 0 0 20px rgba(247, 182, 0, 0.3);
            --success-color: #5aa43c;
            --pending-color: #f7b600;
            --danger-color: #e54a4a;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Supercell-Magic', sans-serif; 
            background-color: var(--background-dark);
            color: var(--text-color); 
            padding: 1.5rem 1rem;
            background-image: url('https://clashofclans.com/bg_battle_02.55185d26.jpg');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            background-repeat: no-repeat;
        }
        .app-container { width: 100%; max-width: 420px; margin: 0 auto; }
        .main-title { 
            font-size: 2.5rem; 
            font-weight: 700; 
            text-align: center; 
            margin-bottom: 0.25rem;
            color: var(--coc-gold);
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }
        .sub-title { 
            text-align: center; 
            color: var(--text-light); 
            font-weight: 500; 
            margin-bottom: 2rem;
            font-size: 1.2rem;
            text-transform: uppercase;
        }
        nav {
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* Added for responsiveness */
            gap: 0.5rem; /* Adjusted gap */
            margin-bottom: 2rem;
        }
        .nav-link {
            font-family: 'Supercell-Magic', sans-serif;
            font-size: 0.9rem; /* Adjusted font size */
            font-weight: 700;
            color: var(--text-light);
            background: var(--input-dark);
            border: 2px solid var(--border-color);
            padding: 0.6rem 0.8rem; /* Adjusted padding */
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            text-transform: uppercase;
            transition: all 0.3s;
        }
        .nav-link.active, .nav-link:hover {
            color: var(--background-dark);
            background: var(--coc-gold);
            border-color: var(--coc-gold);
        }
        .card { 
            background: var(--card-dark); 
            border-radius: 12px; 
            box-shadow: var(--card-shadow); 
            margin-bottom: 1.5rem;
            border: 2px solid var(--border-color);
            backdrop-filter: blur(5px);
        }
        .card-header { 
            padding: 1rem 1.25rem; 
            font-size: 1.5rem;
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            gap: 0.75rem; 
            border-bottom: 2px solid var(--border-color);
            letter-spacing: 1px;
            color: var(--coc-gold);
        }
        .card-header .icon { 
            width: 32px; 
            height: 32px; 
            color: var(--coc-gold); 
            display: flex; 
            justify-content: center; 
            align-items: center;
            font-size: 1.8rem;
        }
        .card-body { padding: 1.25rem; }
        .form-group { margin-bottom: 1rem; }
        .form-label { 
            display: block; 
            margin-bottom: 0.5rem; 
            font-weight: 700; 
            font-size: 1.2rem; 
            color: #ccc; 
            text-transform: uppercase;
        }
        .form-control { 
            width: 100%; 
            padding: 0.8rem 1rem; 
            border: 2px solid var(--border-color); 
            border-radius: 8px; 
            font-size: 1.2rem;
            font-family: 'Supercell-Magic', sans-serif;
            background-color: var(--input-dark); 
            color: var(--text-color);
            transition: all 0.3s; 
        }
        .form-control::placeholder {
            color: #666;
        }
        .form-control:focus { 
            border-color: var(--coc-gold); 
            outline: none; 
            box-shadow: 0 0 10px rgba(247, 182, 0, 0.7);
        }
        .btn-topup { 
            width: 100%; 
            padding: 0.9rem; 
            font-size: 1.5rem; 
            font-weight: 700; 
            letter-spacing: 2px;
            color: var(--background-dark); 
            background: var(--coc-gold); 
            border: 2px solid var(--coc-gold);
            border-radius: 8px; 
            cursor: pointer; 
            transition: all 0.3s;
            text-transform: uppercase;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .btn-topup:disabled { background: #333; color: #666; border-color: #444; cursor: not-allowed; text-shadow: none;}
        .btn-topup:hover:not(:disabled) {
            box-shadow: 0 0 15px var(--coc-gold);
        }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .gem-option { 
            background-color: var(--input-dark); 
            border: 2px solid var(--border-color); 
            padding: 0.9rem 0.5rem; 
            border-radius: 8px; 
            cursor: pointer; 
            text-align: center; 
            font-weight: 700; 
            font-size: 1.1rem; 
            color: #ccc; 
            transition: all 0.2s; 
        }
        .gem-option.selected { 
            border-color: var(--coc-gold); 
            background-color: var(--coc-gold); 
            color: var(--background-dark); 
            font-weight: 700; 
        }
        .content-section .card-body p {
            line-height: 1.6;
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--text-light);
            white-space: pre-wrap; /* To respect newlines from Firebase */
        }
        .content-section .card-body h4 {
            font-size: 1.2rem;
            color: var(--coc-gold);
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .dynamic-content-item {
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        .dynamic-content-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index: 1000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-content { background: var(--card-dark); padding: 2rem; border-radius: 12px; width: 90%; max-width: 360px; text-align: center; border: 2px solid var(--border-color); }
        .modal-content h3 { font-size: 1.8rem; color: var(--coc-gold); text-shadow: 0 0 5px var(--coc-gold); }
        .modal-content p { font-size: 1.1rem; }
        .btn-ad { width: 100%; padding: 0.8rem; border-radius: 10px; border: 2px solid var(--coc-gold); color: var(--coc-gold); background: transparent; font-weight: 600; font-family: 'Supercell-Magic', sans-serif; font-size: 1.1rem; cursor: pointer; transition: all 0.2s; }
        .btn-ad:hover { background: var(--coc-gold); color: var(--background-dark); }
        .btn-ad.watched { background: var(--success-color); border-color: var(--success-color); color: #fff; }
        .btn-cancel { width: 100%; padding: 0.8rem; border-radius: 10px; border: 2px solid var(--danger-color); color: var(--danger-color); background: transparent; font-weight: 600; cursor: pointer; margin-top: 1rem; font-family: 'Supercell-Magic', sans-serif; font-size: 1.1rem; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; font-size: 1.1rem; border-bottom: 2px solid var(--border-color); }
        .list-item:last-child { border-bottom: none; }
        .status-badge { padding: 0.2rem 0.7rem; border-radius: 20px; font-size: 0.9rem; font-weight: 700; color: white; text-transform: uppercase; }
        .status-badge.success { background-color: var(--success-color); color: #fff; }
        .status-badge.pending { background-color: var(--pending-color); color: #333; }
        .btn-speed-up { background: #222; color: #ccc; border: 2px solid var(--border-color); padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 700; margin-top: 0.5rem; font-family: 'Supercell-Magic', sans-serif; }
        .btn-speed-up:disabled { opacity: 0.5; cursor: not-allowed; }
        #success-toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: var(--card-dark); color: white; padding: 1rem 1.5rem; border-radius: 8px; z-index: 1000; font-weight: 700; transition: bottom 0.5s; border: 2px solid var(--coc-gold); font-size: 1.1rem; backdrop-filter: blur(5px); }
        #success-toast.show { bottom: 20px; }
    </style>
</head>
<body>
    <div class="app-container">

        <!-- Banner 320x50 Ad Placement -->
        <div style="text-align: center; margin-bottom: 1rem;">
            <script type="text/javascript">
                atOptions = {
                    'key' : 'e3e8c243b5741cf0268f38cd219d4ab9',
                    'format' : 'iframe',
                    'height' : 50,
                    'width' : 320,
                    'params' : {}
                };
            </script>
            <script type="text/javascript" src="//www.highperformanceformat.com/e3e8c243b5741cf0268f38cd219d4ab9/invoke.js"></script>
        </div>

        <h2 class="main-title">Clash of Clans Gem Top-up</h2>
        <p class="sub-title">Your Ultimate Gem Resource</p>
        
        <nav>
            <a href="#" class="nav-link active" data-target="topup-section">Top-up</a>
            <a href="#" class="nav-link" data-target="blog-section">Blog</a>
            <a href="#" class="nav-link" data-target="how-to-use-section">How to Use</a>
            <a href="#" class="nav-link" data-target="faq-section">FAQ</a>
            <a href="#" class="nav-link" data-target="about-us-section">About Us</a>
        </nav>

        <div id="topup-section" class="content-section">
            <form id="topupForm" onsubmit="return false;">
                <div class="card">
                    <div class="card-header">
                        <div class="icon"><i class="fa-solid fa-hashtag"></i></div>
                        <span>Account Info</span>
                    </div>
                    <div class="card-body">
                        <label for="playerTag" class="form-label">Player Tag</label>
                        <input type="text" class="form-control" id="playerTag" placeholder="Enter your tag (min 4 characters)" required>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="icon"><i class="fa-solid fa-gem"></i></div>
                        <span>Select Recharge</span>
                    </div>
                    <div class="card-body">
                        <div id="gemOptionsGrid" class="options-grid"></div>
                    </div>
                </div>
                <button type="button" class="btn-topup" id="topupButton" disabled>
                    <span id="btnText">Top-up Now</span>
                </button>
            </form>

            <!-- Native Banner Ad Placement -->
            <div style="margin-top: 1.5rem; margin-bottom: 0rem;">
                <script async="async" data-cfasync="false" src="//pl27680057.revenuecpmgate.com/ba8084bb5644d872d51ae8d33bf1bd8b/invoke.js"></script>
                <div id="container-ba8084bb5644d872d51ae8d33bf1bd8b"></div>
            </div>

            <div class="card" id="historyCard" style="display: none; margin-top: 2rem;">
                <div class="card-header">
                    <div class="icon"><i class="fa-solid fa-scroll"></i></div>
                    <span>Your History</span>
                </div>
                <div class="card-body" style="padding: 0 1.25rem;"><div id="historyList" class="history-list"></div></div>
            </div>
            <div class="card" id="liveTopupCard" style="margin-top: 2rem;">
                <div class="card-header">
                    <div class="icon"><i class="fa-solid fa-satellite-dish"></i></div>
                    <span>Recent Top-ups</span>
                </div>
                <div class="card-body" style="padding: 0 1.25rem;"><div id="liveTopupList" class="live-topup-list"></div></div>
            </div>
        </div>

        <div id="blog-section" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <div class="icon"><i class="fa-solid fa-newspaper"></i></div>
                    <span>Clash Blog</span>
                </div>
                <div class="card-body" id="blog-container">
                    <div class="dynamic-content-item">
                        <h4>How to Get Free COC Gems in 2025 — What Really Works?</h4>
                        <p>Many Clash of Clans players dream of getting <b>Free COC Gems</b> without spending money. You may have already searched for a <i>free Clash of Clans gem generator</i> or ways to get <b>unlimited gems hack in Clash of Clans</b>. The truth is, most “hack” websites or fake generators don’t actually work — and many can even harm your account.<br><br>So, how can you really get gems? 👉 First, take advantage of official <b>events</b> inside Clash of Clans. Supercell often rewards players with free gems during special challenges. 👉 Second, you can earn gems by <b>completing achievements</b> (for example, “Sweet Victory” or “League All-Star”). 👉 Third, consider safe methods like <b>Google Opinion Rewards</b> or official gift card offers, which you can redeem for gems.<br><br>While there are many claims about an “unlimited gems hack Clash of Clans,” most of them are scams. Instead of risking your account, focus on safe and proven strategies. With patience and consistency, you can collect free gems and enjoy the game without spending money.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="how-to-use-section" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <div class="icon"><i class="fa-solid fa-circle-info"></i></div>
                    <span>How To Use</span>
                </div>
                <div class="card-body" id="how-to-use-container">
                    <div class="dynamic-content-item">
                         <h4>How to Use Our Free Clash of Clans Gem Generator</h4>
                         <p>1. Open the tool from the menu.<br><br>2. Enter your Clash of Clans username.<br><br>3. Choose the number of gems you want.<br><br>4. Click “Generate” and wait for the process. ⚠️ Note: This tool is for entertainment/demo purposes only. It does not provide unlimited gems hack, but helps you learn safe ways to collect gems.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="faq-section" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <div class="icon"><i class="fa-solid fa-circle-question"></i></div>
                    <span>FAQ</span>
                </div>
                <div class="card-body" id="faq-container">
                    <div class="dynamic-content-item">
                        <h4>Frequently Asked Questions About Free COC Gems</h4>
                    </div>
                    <div class="dynamic-content-item">
                        <h4>Q1: Can I really get Free COC Gems?</h4>
                        <p>Yes, but only through <b>official events, achievements, and rewards</b>. Fake unlimited gems hacks are not real.</p>
                    </div>
                    <div class="dynamic-content-item">
                        <h4>Q2: Do free Clash of Clans gem generators work?</h4>
                        <p>Most online generators are fake. Our tool is for demo/learning purposes only. Always focus on safe methods.</p>
                    </div>
                    <div class="dynamic-content-item">
                        <h4>Q3: How to get free gems without spending money?</h4>
                        <p>Play in-game events, complete achievements, and try gift card reward apps. These are legit ways.</p>
                    </div>
                    <div class="dynamic-content-item">
                        <h4>Q4: Is unlimited gems hack Clash of Clans safe?</h4>
                        <p>No, unlimited hack offers are scams and can get your account banned. Avoid them.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="about-us-section" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <div class="icon"><i class="fa-solid fa-users"></i></div>
                    <span>About Us</span>
                </div>
                <div class="card-body" id="about-us-container">
                    <!-- "About Us" content will be loaded here from Firebase -->
                </div>
            </div>
        </div>

    </div>
    
    <div id="adModal" class="modal-overlay">
        <div class="modal-content" id="modalContent"></div>
    </div>
    <div id="success-toast"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
    
<script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBQx8Cwg-yJN0dHLSPiNi9wkTcAi5-twYg",
        authDomain: "buy-sell-ceb1b.firebaseapp.com",
        databaseURL: "https://buy-sell-ceb1b-default-rtdb.firebaseio.com",
        projectId: "buy-sell-ceb1b",
        storageBucket: "buy-sell-ceb1b.firebasestorage.app",
        messagingSenderId: "584552517627",
        appId: "1:584552517627:web:5310b5d00a45eaf6fc455e",
        measurementId: "G-S9TG70JE5K"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
    const database = firebase.database();

document.addEventListener('DOMContentLoaded', () => {

    // --- Start of Firebase Dynamic Content Logic ---

    // Function to render content for sections like Blog, FAQ, etc.
    const renderDynamicSection = (dbPath, containerId) => {
        const container = document.getElementById(containerId);
        const contentRef = database.ref(dbPath);
        
        contentRef.on('value', (snapshot) => {
            container.innerHTML = ''; // Clear previous content
            if (snapshot.exists()) {
                snapshot.forEach((childSnapshot) => {
                    const item = childSnapshot.val();
                    const itemElement = document.createElement('div');
                    itemElement.className = 'dynamic-content-item';
                    
                    let contentHTML = '';
                    if (item.title) {
                        contentHTML += `<h4>${item.title}</h4>`;
                    }
                    if (item.content) {
                        contentHTML += `<p>${item.content}</p>`;
                    }
                    itemElement.innerHTML = contentHTML;
                    container.appendChild(itemElement);
                });
            } else {
                // Keep existing static content if Firebase has no data, 
                // unless it's the 'About Us' container.
                if (containerId === 'about-us-container') {
                    container.innerHTML = '<p>Content coming soon...</p>';
                }
            }
        });
    };
    
    // The new content has been added directly to the HTML.
    // The Firebase calls for blog, how-to-use, and FAQ are no longer needed
    // to fetch that specific content. We only keep the one for 'About Us'.
    renderDynamicSection('content/aboutUs', 'about-us-container');


    // --- End of Firebase Dynamic Content Logic ---


    // --- Start of Top-up Logic (Validation Rule Changed) ---
    const DIRECT_LINK_URL = 'https://bracecherry.com/u6a337e7?key=3325650cf041e83fe4b4f2c8585e55e2'; 
    const playerTagInput = document.getElementById('playerTag');
    const gemGrid = document.getElementById('gemOptionsGrid');
    const topupButton = document.getElementById('topupButton');
    const historyCard = document.getElementById('historyCard');
    const historyList = document.getElementById('historyList');
    const adModal = document.getElementById('adModal');
    const modalContent = document.getElementById('modalContent');
    
    let selectedGemIndex = null;
    let activeTimerInterval = null;

    const gameData = {
        gemPackages: [ 
            { text: '80 Gems', value: 80, ads: 1 },
            { text: '500 Gems', value: 500, ads: 1 },
            { text: '1200 Gems', value: 1200, ads: 1 }, 
            { text: '2500 Gems', value: 2500, ads: 2 },
            { text: '6500 Gems', value: 6500, ads: 2 }, 
            { text: '14000 Gems', value: 14000, ads: 2 },
            { text: 'Gold Pass', value: 'Gold Pass', ads: 1 }
        ]
        // The specific validation regex has been removed to implement the new logic.
    };
    
    function populateGemPackages(packages) {
        gemGrid.innerHTML = '';
        selectedGemIndex = null;
        packages.forEach((pkg, index) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'gem-option';
            button.textContent = pkg.text;
            button.dataset.index = index;
            button.addEventListener('click', () => {
                const currentSelected = gemGrid.querySelector('.selected');
                if (currentSelected) currentSelected.classList.remove('selected');
                button.classList.add('selected');
                selectedGemIndex = index;
                validateForm();
            });
            gemGrid.appendChild(button);
        });
    }

    function showVerificationModal() {
        const gemData = gameData.gemPackages[selectedGemIndex];
        let adsWatched = 0;
        
        modalContent.innerHTML = `
            <h3>Verification Required</h3>
            <p style="margin: 1rem 0; color: var(--text-light);">To continue, please complete ${gemData.ads} steps. You must wait 10 seconds on the opened page.</p>
            <div id="adButtonsContainer" style="display: flex; flex-direction: column; gap: 1rem; width: 100%;"></div>
            <button class="btn-cancel" id="cancelAdProcess">Cancel Process</button>
        `;
        
        const adButtonsContainer = modalContent.querySelector('#adButtonsContainer');
        
        for (let i = 0; i < gemData.ads; i++) {
            const adButton = document.createElement('button');
            adButton.className = 'btn-ad';
            adButton.innerHTML = `<i class="fas fa-play-circle"></i> Start Step (${i + 1}/${gemData.ads})`;
            adButton.disabled = (i > 0);
            
            adButton.addEventListener('click', () => {
                createVerificationAdFlow(adButton, () => {
                    adButton.innerHTML = `<i class="fas fa-check-circle"></i> Step Complete!`;
                    adButton.classList.add('watched');
                    adButton.disabled = true;
                    adsWatched++;
                    if (adsWatched >= gemData.ads) {
                        adModal.classList.remove('show');
                        startTopupProcess();
                    } else {
                        const nextButton = adButtonsContainer.querySelectorAll('.btn-ad')[adsWatched];
                        if (nextButton) nextButton.disabled = false;
                    }
                });
            });
            adButtonsContainer.appendChild(adButton);
        }
        
        modalContent.querySelector('#cancelAdProcess').addEventListener('click', () => { adModal.classList.remove('show'); clearVerificationState(); });
        adModal.classList.add('show');
    }
    
    function createVerificationAdFlow(button, onComplete) {
        if (localStorage.getItem('activeTimer')) return;
        const adWindow = window.open(DIRECT_LINK_URL, '_blank');
        const endTime = Date.now() + 10000;
        localStorage.setItem('activeTimer', JSON.stringify({ endTime }));
        
        const checkWindowClosed = setInterval(() => {
            if (!adWindow || adWindow.closed) {
                clearInterval(checkWindowClosed);
                if (Date.now() < endTime) {
                    showToast('Cancelled! You closed the page too early.', 'danger');
                    adModal.classList.remove('show');
                    clearVerificationState();
                }
            }
        }, 500);
        runTimerLoop(button, endTime, onComplete);
    }

    function runTimerLoop(button, endTime, onComplete) {
        if (activeTimerInterval) clearInterval(activeTimerInterval);
        button.disabled = true;
        activeTimerInterval = setInterval(() => {
            const remainingTime = Math.max(0, endTime - Date.now());
            if (remainingTime > 0) {
                button.innerHTML = `<i class="fas fa-hourglass-half"></i> Wait ${Math.ceil(remainingTime / 1000)}s...`;
            } else {
                clearInterval(activeTimerInterval);
                activeTimerInterval = null;
                localStorage.removeItem('activeTimer');
                onComplete();
            }
        }, 250);
    }
    
    function handleSpeedUp(index) {
        const history = JSON.parse(localStorage.getItem('topupHistory')) || [];
        const entry = history[index];
        if (!entry || entry.adsWatched >= 3) return;

        modalContent.innerHTML = `
            <h3>Speed Up Top-up</h3>
            <p style="margin: 1rem 0; color: var(--text-light);">Complete a quick step to cut the remaining waiting time in half.</p>
            <button class="btn-ad" id="speedUpAdButton"><i class="fas fa-forward"></i> Start Speed-up Step</button>
            <button class="btn-cancel" id="cancelSpeedUp">Cancel</button>
        `;
        
        modalContent.querySelector('#speedUpAdButton').addEventListener('click', (e) => {
            createVerificationAdFlow(e.currentTarget, () => {
                const currentHistory = JSON.parse(localStorage.getItem('topupHistory')) || [];
                const currentEntry = currentHistory[index];
                if(currentEntry && currentEntry.status === 'pending') {
                    currentEntry.endTime -= (currentEntry.endTime - Date.now()) / 2;
                    currentEntry.adsWatched += 1;
                    localStorage.setItem('topupHistory', JSON.stringify(currentHistory));
                    showToast('Remaining time has been halved!');
                    adModal.classList.remove('show');
                    renderHistory();
                }
            });
        });
        
        modalContent.querySelector('#cancelSpeedUp').addEventListener('click', () => { adModal.classList.remove('show'); clearVerificationState(); });
        adModal.classList.add('show');
    }

    function startTopupProcess() {
        showToast(`Top-up is pending. Please check history.`);
        saveHistory();
        document.getElementById('topupForm').reset();
        populateGemPackages(gameData.gemPackages);
        topupButton.disabled = true;
    }
    
    function saveHistory() {
        const gemData = gameData.gemPackages[selectedGemIndex];
        const newEntry = {
            tag: playerTagInput.value.toUpperCase(), package: gemData.text, date: new Date().toISOString(), status: 'pending', 
            endTime: Date.now() + 3 * 60 * 60 * 1000, adsWatched: 0
        };
        let history = JSON.parse(localStorage.getItem('topupHistory')) || [];
        history.unshift(newEntry);
        localStorage.setItem('topupHistory', JSON.stringify(history.slice(0, 5)));
        renderHistory();
    }

    function renderHistory() {
        const history = JSON.parse(localStorage.getItem('topupHistory')) || [];
        historyCard.style.display = history.length > 0 ? 'block' : 'none';
        historyList.innerHTML = '';
        history.forEach((entry, index) => {
             const listItem = document.createElement('div');
             listItem.className = 'list-item';
             
             let statusSection;
             if(entry.status === 'success') {
                statusSection = `<span class="status-badge success">Success</span>`;
             } else {
                 statusSection = `<div style="text-align: right;">
                    <span class="status-badge pending">Pending</span>
                    <div class="timer-display" data-index="${index}" style="font-size:1rem; margin-top: 4px;">${formatTime(entry.endTime - Date.now())}</div>
                    <button class="btn-speed-up" data-index="${index}" ${entry.adsWatched >= 3 ? 'disabled' : ''}>Speed Up (${entry.adsWatched}/3)</button>
                 </div>`;
             }
             listItem.innerHTML = `
                <div>
                    <strong style="display:block;">TAG: ${entry.tag}</strong>
                    <span style="color:var(--text-light); font-size: 0.9rem;">${entry.package}</span>
                </div>
                ${statusSection}`;
             historyList.appendChild(listItem);
        });
        historyList.querySelectorAll('.btn-speed-up').forEach(button => {
            button.addEventListener('click', (e) => handleSpeedUp(parseInt(e.currentTarget.dataset.index)));
        });
    }

    function generateLiveTopup() {
        const liveTopupList = document.getElementById('liveTopupList'); 
        const chars = '0289PYLQGRJCUV';
        let randomTag = '#';
        for (let i = 0; i < 8; i++) {
            randomTag += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        
        const amounts = ['Gold Pass', '500 Gems', '1200 Gems', '80 Gems'];
        const listItem = document.createElement('div'); 
        listItem.className = 'list-item'; 
        listItem.innerHTML = `
            <span>Tag: ${randomTag}**</span>
            <div style="display: flex; align-items: center; gap: 0.6rem;">
                <strong style="font-weight: 500;">${amounts[Math.floor(Math.random()*amounts.length)]}</strong>
                <span class="status-badge success">Success</span>
            </div>`;
        liveTopupList.prepend(listItem); 
        if (liveTopupList.children.length > 3) liveTopupList.lastChild.remove(); 
    }
    
    // --- MODIFIED VALIDATION FUNCTION ---
    function validateForm() {
        const tag = playerTagInput.value;
        // The button is enabled if the tag length is greater than 3 AND a gem package is selected.
        topupButton.disabled = !(tag.length > 3 && selectedGemIndex !== null);
    }
    
    function showToast(message, type = 'normal') {
        const toast = document.getElementById('success-toast');
        toast.textContent = message;
        toast.style.backgroundColor = type === 'danger' ? 'var(--danger-color)' : 'var(--card-dark)';
        toast.style.borderColor = type === 'danger' ? 'var(--danger-color)' : 'var(--coc-gold)';
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 4000);
    }

    function formatTime(ms) {
        if (ms < 0) return '00:00:00';
        const h = String(Math.floor(ms / 3600000)).padStart(2, '0');
        const m = String(Math.floor((ms % 3600000) / 60000)).padStart(2, '0');
        const s = String(Math.floor((ms % 60000) / 1000)).padStart(2, '0');
        return `${h}:${m}:${s}`;
    }

    function updateAllTimers() {
        let needsRender = false;
        const history = JSON.parse(localStorage.getItem('topupHistory')) || [];
        history.forEach((entry) => {
            if (entry.status === 'pending' && entry.endTime - Date.now() < 1000) {
                entry.status = 'success';
                needsRender = true;
            }
        });
        if (needsRender) {
            localStorage.setItem('topupHistory', JSON.stringify(history));
            renderHistory();
        } else {
             document.querySelectorAll('.timer-display').forEach(el => {
                const entry = history[el.dataset.index];
                if (entry) el.textContent = formatTime(entry.endTime - Date.now());
             });
        }
    }
    
    function clearVerificationState() {
        localStorage.removeItem('activeTimer');
        if(activeTimerInterval) clearInterval(activeTimerInterval);
        activeTimerInterval = null;
    }

    // --- EVENT LISTENERS ---
    const navLinks = document.querySelectorAll('.nav-link');
    const contentSections = document.querySelectorAll('.content-section');

    playerTagInput.addEventListener('input', validateForm);
    topupButton.addEventListener('click', showVerificationModal);

    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = link.getAttribute('data-target');

            contentSections.forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(targetId).style.display = 'block';

            navLinks.forEach(navLink => {
                navLink.classList.remove('active');
            });
            link.classList.add('active');
        });
    });
    
    // --- INITIALIZATION ---
    populateGemPackages(gameData.gemPackages);
    renderHistory();
    setInterval(generateLiveTopup, 4500);
    setInterval(updateAllTimers, 1000);

});
</script>

<!-- Social Bar Ad Script -->
<script async type='text/javascript' src='//pl27680051.revenuecpmgate.com/c8/73/a6/c873a6475228e4f8f343ea6cfb0c110a.js'></script>

</body>
</html>
